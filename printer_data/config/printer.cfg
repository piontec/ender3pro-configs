[include fluidd.cfg]

[include macros.cfg]
# This file contains pin mappings for the stock 2020 Creality Ender 3
# Pro with the 32-bit Creality 4.2.2 board. To use this config, during
# "make menuconfig" select the STM32F103 with a "28KiB bootloader" and
# serial (on USART1 PA10/PA9) communication.

# If you prefer a direct serial connection, in "make menuconfig"
# select "Enable extra low-level configuration options" and select
# serial (on USART3 PB11/PB10), which is broken out on the 10 pin IDC
# cable used for the LCD module as follows:
# 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.

# See docs/Config_Reference.md for a description of parameters.

[stepper_x]
step_pin: PC0
dir_pin: PB2
enable_pin: !PC13
microsteps: 128
rotation_distance: 40
endstop_pin: ^PA12
position_endstop: -6
position_min: -6
position_max: 230
homing_speed: 50

[stepper_y]
step_pin: PC2
dir_pin: PB9
enable_pin: !PB12
microsteps: 128
rotation_distance: 40
endstop_pin: ^PA11
position_endstop: -3
position_min: -3
position_max: 226
homing_speed: 50

[stepper_z]
step_pin: PC14
dir_pin: !PC15
enable_pin: !PB8
microsteps: 128
rotation_distance: 8
#endstop_pin: ^PC6
#position_endstop: 0
endstop_pin: probe:z_virtual_endstop
position_min: -3
position_max: 250


[extruder]
max_extrude_cross_section: 1.2
max_extrude_only_distance: 100.0
step_pin: PB4
dir_pin: PB3
enable_pin: !PB5
microsteps: 128
#rotation_distance: 30.9174
#rotation_distance: 23.6919
#rotation_distance: 23.313
#rotation_distance: 23.126
rotation_distance: 23.3665
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC9
#sensor_type: EPCOS 100K B57560G104F
sensor_type: PT1000
sensor_pin: PA0
#control: pid
# tuned for stock hardware with 200 degree Celsius target
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
#max_temp: 260
max_temp: 300
# 0.4 nozzle
pressure_advance: 0.03
# 0.8 nozzle
#pressure_advance: 0.06
gear_ratio: 3:1

[tmc2209 stepper_x]
uart_pin: PC7
run_current: 0.700
interpolate: False
stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 0.700
interpolate: False
stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PC12
run_current: 0.600
interpolate: False
stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PC11
run_current: 0.450
interpolate: False
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PC8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
#control: pid
# tuned for stock hardware with 50 degree Celsius target
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA8

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 3100
max_z_velocity: 5
max_z_accel: 200

[idle_timeout]
timeout: 1800

#[output_pin probe_enable]
#pin: PC4
#value: 0
#
#[gcode_macro Probe_Deploy]
#gcode:
# SET_PIN PIN=probe_enable VALUE=1
#
#[gcode_macro Probe_Stow]
#gcode:
# SET_PIN PIN=probe_enable VALUE=0
#
#[probe]
#pin: ^!PC10 # For V1 version, set to ^PC13 for high-level trigger; for V2 version, set to ^!PC13 for low-level trigger.
#deactivate_on_each_sample: False
#x_offset: 25
#y_offset: 7.5
##z_offset: -1.0
#speed: 2.0
#samples: 3
#samples_result: average
#samples_tolerance: 0.02
#samples_tolerance_retries: 3
#activate_gcode:
# Probe_Deploy
# G4 P500 # Allow 500 milliseconds for the probe to deploy
#deactivate_gcode:
# Probe_Stow

# The MCU section only applies to the Eddy USB. For Eddy Coil you will use the MCU name of the toolboard that you connected the Eddy Coil to.
[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044506128883C1C-if00
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 0.5
#i2c_address:
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
# Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
# For a standard Voron stealthburner X carriage mount there should be no need to change the defaults below.
x_offset: 33
y_offset: 15.5

# This section is only relevant for Eddy USB. Comment it out for Eddy Coil.
[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2
# calibration_position: 115 112 2
calibration_extruder_temp: 160
#calibration_bed_temp: 50
extruder_heating_z: 30

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[force_move]
enable_force_move: True # Allows a user to move the z axis down if they have no other means of homing Z and need to calibrate the Eddy.

#[filament_motion_sensor my_sensor]
#detection_length: 200
#extruder: extruder
#pause_on_runout: True
#runout_gcode: M600
#switch_pin: PB10

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[safe_z_home]
home_xy_position: 110, 110 # Choose an X,Y position that is in the center of your bed. For a 300x300 machine that will be 150, 150. Use the same principle to calculate your bed center.
z_hop: 10
z_hop_speed: 25
speed: 200

[bed_mesh]
horizontal_move_z: 2
speed: 200
# For the mesh dimensions below, the coordinates need to be reachable by the center of the probe. To calculate coordinates that will work, use the formula below:
# mesh x min = position_min_x + greater_of (15mm or x_offset) <--- in this term, only consider the x offset if it is positive, ignore if negative.
# mesh y min = position_min_y + greater_of (15mm or y_offset) <--- in this term, only consider the y offset if it is positive, ignore if negative.
# mesh x max = position_max_x - greater_of (15mm or |x_offset|) <--- in this term, only consider the x offset if it is negative, ignore if positive.
# mesh y max = position_max_y - greater_of (15mm or |y_offset|) <--- in this term, only consider the y offset if it is negative, ignore if positive.
# Example: Consider that you have a 300 x 300 bed with the max x and y positions being 300 and the min being 0. Your probe offsets are -20 for X and 10 for Y
# For mesh x min we ignore the x offset term because it is negative. Therefore mesh x min = 15
# For mesh y min we do not ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y min = 15
# For mesh x max we do not ignore the x offset term because it is negative. It is also greater than 15. Therefore mesh x max = 280
# For mesh y max we ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y max = 285
# The final result would be mesh_min: 15, 15 mesh_max: 280, 285
mesh_min: 41, 15.5  # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
mesh_max: 215, 220 # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
probe_count: 9, 9
algorithm: bicubic
scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

# EXP1 / EXP2 () pins
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC3, EXP1_3=PA4, EXP1_5=PA6, EXP1_7=PC4, EXP1_9=<GND>,
    EXP1_2=PC1, EXP1_4=PA5, EXP1_6=PA7, EXP1_8=PC5, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB14, EXP2_3=PB11, EXP2_5=PB0,  EXP2_7=PC10,  EXP2_9=<GND>,
    EXP2_2=PB13, EXP2_4=PA15, EXP2_6=PB15, EXP2_8=<RST>, EXP2_10=<NC>,
    # CR_EXP3 header
    CR_EXP3_1=<5V>,  CR_EXP3_3=PA4, CR_EXP3_5=PA6, CR_EXP3_7=<RST>, CR_EXP3_9=PC3,
    CR_EXP3_2=<GND>, CR_EXP3_4=PA5, CR_EXP3_6=PB0, CR_EXP3_8=PB11,  CR_EXP3_10=PC1


[display]
lcd_type: st7920
sid_pin: CR_EXP3_3
cs_pin: CR_EXP3_4
sclk_pin: CR_EXP3_5
encoder_pins: ^CR_EXP3_6, ^CR_EXP3_8
click_pin: ^!CR_EXP3_9


[output_pin beeper]
# pin: EXP1_2
pin: CR_EXP3_10

[gcode_arcs]

#[virtual_sdcard]
#path: ~/gcode_files

[bed_screws]
screw1: 0,2.5
screw2: 192,2.5
screw3: 192,175
screw4: 0,175

[screws_tilt_adjust]
# in nozzle's coords
screw1: 7.5,25
screw1_name: front left screw
screw2: 177.5,25
screw2_name: front right screw
screw3: 177.5,195.5
screw3_name: rear right screw
screw4: 7.5,195.5
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 50.
screw_thread: CW-M3

#[neopixel my_neopixel]
#pin: PA2
#chain_count: 1

### ADXL345 auto resonance testing
[mcu rpi]
serial: /tmp/klipper_host_mcu

[temperature_sensor rpi]
sensor_type: temperature_host

[temperature_sensor mcu]
sensor_type: temperature_mcu

#[temperature_sensor Chamber]
#sensor_type = DS18B20
#serial_no = 00-800000000000
#ds18_report_time = 1.0
#sensor_mcu = rpi

[temperature_sensor Enclosure]
sensor_type: BME280
i2c_address: 118
i2c_mcu: rpi
i2c_bus: i2c.1
i2c_speed: 400000

# [temperature_sensor psu]
# sensor_type: BME280
# i2c_address: 119
# i2c_mcu: rpi
# i2c_bus: i2c.1

#[gcode_macro QUERY_BME280]
#gcode:
#    {% set sensor = printer["bme280 enclosure_temp"] %}
#    {action_respond_info(
#        "Temperature: %.2f C\n"
#        "Pressure: %.2f hPa\n"
#        "Humidity: %.2f%%" % (
#            sensor.temperature,
#            sensor.pressure,
#            sensor.humidity))}
#
[output_pin lights]
pin: rpi:gpio20

[fan_generic enclosure]
pin: rpi:gpio21
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:

[gcode_macro LED_ON]
gcode: SET_PIN PIN=lights VALUE=1

[gcode_macro LED_OFF]
gcode: SET_PIN PIN=lights VALUE=0

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    115,105,40

[input_shaper]
shaper_freq_x: 54
shaper_type_x: 3hump_ei
shaper_freq_y: 43.4
shaper_type_y: zv


[skew_correction]
# SET_SKEW XY=70.37,70.28,49.74 XZ=70.63,69.73,49.71 YZ=70.38,70.10,49.78

[exclude_object]

# mniejszy offset - wy≈ºej dysza

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.023089, 0.040202, 0.037063, 0.032849, 0.043792, 0.034914, 0.044122, 0.043155, 0.015178
#*# 	0.114244, 0.127334, 0.124127, 0.109244, 0.111693, 0.109563, 0.104735, 0.099156, 0.035155
#*# 	0.110262, 0.140217, 0.119248, 0.103581, 0.102621, 0.083714, 0.096058, 0.082217, 0.021787
#*# 	0.113594, 0.138869, 0.119415, 0.098910, 0.087398, 0.090584, 0.082275, 0.084946, -0.001878
#*# 	0.103216, 0.135494, 0.110147, 0.095999, 0.077497, 0.058749, 0.067563, 0.053625, 0.000087
#*# 	0.101002, 0.140706, 0.121007, 0.096262, 0.080384, 0.073358, 0.065569, 0.071657, -0.007504
#*# 	0.124700, 0.141894, 0.115169, 0.104080, 0.080350, 0.075102, 0.072188, 0.063107, 0.009363
#*# 	0.180944, 0.147650, 0.121495, 0.106357, 0.091265, 0.079193, 0.070515, 0.069551, 0.022584
#*# 	0.139238, 0.105658, 0.089473, 0.072148, 0.059095, 0.039642, 0.035144, 0.034090, 0.015109
#*# tension = 0.2
#*# min_x = 41.0
#*# algo = bicubic
#*# y_count = 9
#*# mesh_y_pps = 2
#*# min_y = 15.5
#*# x_count = 9
#*# max_y = 219.98000000000002
#*# mesh_x_pps = 2
#*# max_x = 215.0
#*#
#*# [bed_mesh magnetic]
#*# version = 1
#*# points =
#*# 	0.112500, 0.055000, 0.017500, 0.100000, 0.270000
#*# 	0.057500, 0.035000, 0.037500, 0.037500, 0.250000
#*# 	0.032500, 0.000000, 0.007500, 0.032500, 0.210000
#*# 	0.077500, 0.062500, 0.000000, 0.040000, 0.192500
#*# 	-0.345000, 0.032500, 0.015000, 0.050000, 0.177500
#*# tension = 0.2
#*# min_x = 0.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 0.0
#*# x_count = 5
#*# max_y = 214.0
#*# mesh_x_pps = 2
#*# max_x = 199.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.611
#*# pid_ki = 0.847
#*# pid_kd = 150.926
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.508
#*# pid_ki = 1.036
#*# pid_kd = 1067.449
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3292763.965,0.090000:3291982.006,0.130000:3291189.153,
#*# 	0.170000:3290364.964,0.210000:3289582.965,0.250000:3288756.759,
#*# 	0.290000:3287925.702,0.330000:3287118.916,0.370000:3286329.834,
#*# 	0.410000:3285582.068,0.450000:3284807.476,0.490000:3284085.840,
#*# 	0.530000:3283360.405,0.570000:3282674.696,0.610000:3281988.532,
#*# 	0.650000:3281270.991,0.690000:3280553.339,0.730000:3279841.373,
#*# 	0.770000:3279148.845,0.810000:3278462.629,0.850000:3277759.799,
#*# 	0.890000:3277122.429,0.930000:3276476.925,0.970000:3275850.248,
#*# 	1.010000:3275241.339,1.050000:3274619.529,1.090000:3273991.486,
#*# 	1.130000:3273417.857,1.170000:3272763.507,1.210000:3272243.707,
#*# 	1.250000:3271677.817,1.290000:3271126.649,1.330000:3270596.797,
#*# 	1.370000:3270075.889,1.410000:3269553.403,1.450000:3269063.137,
#*# 	1.490000:3268546.525,1.530000:3268047.897,1.570000:3267541.686,
#*# 	1.610000:3267102.014,1.650000:3266631.263,1.690000:3266194.273,
#*# 	1.730000:3265631.078,1.770000:3265321.946,1.810000:3264869.290,
#*# 	1.850000:3264483.762,1.890000:3264060.113,1.930000:3263669.442,
#*# 	1.970000:3263232.955,2.010000:3262876.505,2.050000:3262500.581,
#*# 	2.090000:3262099.950,2.130000:3261732.973,2.170000:3261365.705,
#*# 	2.210000:3260977.437,2.250000:3260667.549,2.290000:3260264.162,
#*# 	2.330000:3259923.017,2.370000:3259583.480,2.410000:3259288.788,
#*# 	2.450000:3258964.986,2.490000:3258635.627,2.530000:3258324.407,
#*# 	2.570000:3258026.175,2.610000:3257694.966,2.650000:3257441.613,
#*# 	2.690000:3257140.667,2.730000:3256834.805,2.770000:3256539.857,
#*# 	2.810000:3256284.978,2.850000:3256012.414,2.890000:3255745.870,
#*# 	2.930000:3255457.735,2.970000:3255228.817,3.010000:3254975.068,
#*# 	3.050000:3254699.500,3.090000:3254459.892,3.130000:3254228.862,
#*# 	3.170000:3253967.879,3.210000:3253771.568,3.250000:3253508.268,
#*# 	3.290000:3253288.588,3.330000:3253044.862,3.370000:3252854.623,
#*# 	3.410000:3252617.485,3.450000:3252412.190,3.490000:3252199.813,
#*# 	3.530000:3251991.777,3.570000:3251766.579,3.610000:3251557.093,
#*# 	3.650000:3251376.069,3.690000:3251158.113,3.730000:3250937.497,
#*# 	3.770000:3250762.034,3.810000:3250585.558,3.850000:3250394.683,
#*# 	3.890000:3250189.140,3.930000:3250001.501,3.970000:3249840.884,
#*# 	4.010000:3249644.884,4.050000:3249474.616
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 40.125103
#*# drift_calibration =
#*# 	3310484.132587, -258.465855, 0.559666
#*# 	3295562.988923, -149.370381, -0.097363
#*# 	3284199.310088, -97.963328, -0.275387
#*# 	3274163.341364, -17.068145, -0.719680
#*# 	3267475.246517, 0.946932, -0.751398
#*# 	3261676.508586, 22.103897, -0.784322
#*# 	3257504.641239, 26.866947, -0.750619
#*# 	3254181.246849, 25.258563, -0.662089
#*# 	3250935.219157, 44.374888, -0.772746
#*# drift_calibration_min_temp = 39.18143243938889
